<!--Website born on 01-30-25
Initiated by Robert Stanley
Co-Authored by Luca Maddaleni & Sean Griffiths for Group Meshtacular in Computer Networks
Spring Semester 2025-->

<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Group Meshtacular Project Website</title>
    <link rel="stylesheet" href="style.css">
    <!--sanitize content before display using DOMPurify-->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/dompurify/3.0.3/purify.min.js"></script>
    <!-- Import Firebase initialization script -->
    <script type="module" src="firebase-init.js"></script>
    <!-- Google tag (gtag.js) -->
    <script async src="https://www.googletagmanager.com/gtag/js?id=G-T0HER5K5PQ"></script>
    <script>
      window.dataLayer = window.dataLayer || [];
      function gtag(){dataLayer.push(arguments);}
      gtag('js', new Date());

      gtag('config', 'G-T0HER5K5PQ');
    </script>
</head>
<body>
    <header>
        <h1>üï∂Ô∏è Welcome to Group Meshtacular</h1>
        <p>üìü The Cyber HQ for Our Networking & Security Portfolio</p>
    </header>

    <!-- Authentication Section -->
    <section id="auth-section">
        <div class="auth-container">
            <div class="auth-form">
                <h2>Sign Up</h2>
                <form id="signup-form" onsubmit="event.preventDefault(); handleSignup();">
                    <input type="email" id="signup-email" placeholder="Email" required>
                    <input type="password" id="signup-password" placeholder="Password" required>
                    <button type="button" onclick="handleSignup()">Sign Up</button>
                </form>
            </div>
            
            <div class="auth-form">
                <h2>Login</h2>
                <form id="login-form" onsubmit="event.preventDefault(); handleLogin();">
                    <input type="email" id="login-email" placeholder="Email" required>
                    <input type="password" id="login-password" placeholder="Password" required>
                    <button type="button" onclick="handleLogin()">Login</button>
                </form>
            </div>
        </div>
    </section>

    <!-- Dashboard (Only visible after login) -->
    <section id="dashboard" style="display:none;">
        <h2>Welcome, <span id="user-email"></span>!</h2>
        
        <!-- Feedback Form -->
        <div class="feedback-container">
            <h3>Submit Feedback</h3>
            <form id="feedback-form" onsubmit="event.preventDefault(); handleFeedbackSubmit();">
                <label for="feedback">Your Feedback:</label>
                <textarea id="feedback" name="feedback" required></textarea>
                <button type="button" onclick="handleFeedbackSubmit()">Submit Feedback</button>
            </form>
        </div>
        
        <!-- Feedback Messages -->
        <div class="feedback-display">
            <h3>Your Submitted Feedback</h3>
            <div id="feedback-messages"></div>
        </div>
        
        <button id="logout">Logout</button>
    </section>

    <!-- Handle Firebase Authentication -->
    <script type="module">
        // Import necessary Firebase modules
        import { getFirebase } from './firebase-init.js';
        import { auth, db } from './firebase-init.js';
        import { createUserWithEmailAndPassword, signInWithEmailAndPassword, signOut, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-auth.js";
        import { collection, addDoc, query, orderBy, where, onSnapshot, doc, setDoc } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore.js";

        // Add extensive debug logging
        console.log("Script loading...");

        // Create error handler for unhandled promise rejections
        window.addEventListener('unhandledrejection', function(event) {
            console.error('Unhandled promise rejection:', event.reason);
        });

        // Setup debug logging for form submissions
        const debugEvent = (name) => {
            return (...args) => {
                console.log(`Event '${name}' triggered with:`, args);
            };
        };

        // Monitor for clicks
        document.addEventListener('click', (e) => {
            if (e.target.tagName === 'BUTTON') {
                console.log("Button clicked:", e.target.textContent, e.target);
            }
        });

        // Clean up URL if it contains the _csrf parameter
        if (window.location.search.includes('_csrf=')) {
            const cleanUrl = window.location.pathname;
            window.history.replaceState({}, document.title, cleanUrl);
            console.log("URL cleaned from CSRF parameter");
        }

        // DOM Elements
        const authSection = document.getElementById("auth-section");
        const dashboard = document.getElementById("dashboard");
        const userEmailSpan = document.getElementById("user-email");
        const signupForm = document.getElementById("signup-form");
        const loginForm = document.getElementById("login-form");
        const feedbackForm = document.getElementById("feedback-form");
        const feedbackMessages = document.getElementById("feedback-messages");
        const logoutButton = document.getElementById("logout");

        // Global variables for Firebase services
        let globalAuth, globalDb;

        // Try to get Firebase services directly
        try {
            globalAuth = auth;
            globalDb = db;
            console.log("Firebase services accessed directly:", !!globalAuth, !!globalDb);
            
            // If we have both services, setup immediately
            if (globalAuth && globalDb) {
                console.log("Firebase services available, setting up immediately");
                setupAuthHandlers();
            }
        } catch (error) {
            console.log("Couldn't get Firebase services directly, waiting for initialization event");
        }

        // Wait for Firebase to initialize (as a backup)
        document.addEventListener('firebaseInitialized', () => {
            console.log("Firebase initialized event received");
            setupAuthHandlers();
        });

        // Define handler functions for button clicks
        window.handleSignup = function() {
            const email = document.getElementById("signup-email").value;
            const password = document.getElementById("signup-password").value;
            
            if (!email || !password) {
                alert("‚ö†Ô∏è Email and password are required");
                return;
            }
            
            createUserWithEmailAndPassword(globalAuth, email, password)
                .then(async (userCredential) => {
                    const user = userCredential.user;
                    
                    // Save user to Firestore
                    await setDoc(doc(globalDb, "users", user.uid), { 
                        email: user.email,
                        createdAt: new Date()
                    });
                    
                    alert("‚úÖ Signup Successful! You can now log in.");
                    signupForm.reset();
                })
                .catch((error) => {
                    console.error("Signup error:", error);
                    alert("‚ö†Ô∏è " + error.message);
                });
        };

        window.handleLogin = function() {
            const email = document.getElementById("login-email").value;
            const password = document.getElementById("login-password").value;
            
            if (!email || !password) {
                alert("‚ö†Ô∏è Email and password are required");
                return;
            }
            
            signInWithEmailAndPassword(globalAuth, email, password)
                .then((userCredential) => {
                    const user = userCredential.user;
                    userEmailSpan.textContent = user.email;
                    
                    // Show dashboard, hide auth section
                    authSection.style.display = "none";
                    dashboard.style.display = "block";
                    
                    // Load user's feedback
                    loadUserFeedback(user.uid);
                })
                .catch((error) => {
                    console.error("Login error:", error);
                    alert("‚ö†Ô∏è " + error.message);
                });
        };

        window.handleFeedbackSubmit = function() {
            const feedbackText = document.getElementById("feedback").value;
            const user = globalAuth.currentUser;
            
            if (!user) {
                alert("‚ö†Ô∏è You must be logged in to submit feedback.");
                return;
            }
            
            if (!feedbackText.trim()) {
                alert("‚ö†Ô∏è Please enter some feedback before submitting.");
                return;
            }
            
            console.log("Submitting feedback for user:", user.uid);
            
            // Create a timestamp to use in the feedback document
            const timestamp = new Date();
            
            // Add the feedback document to Firestore
            addDoc(collection(globalDb, "feedback"), {
                userId: user.uid,
                email: user.email,
                feedback: feedbackText,
                timestamp: timestamp
            })
            .then((docRef) => {
                console.log("Feedback submitted with ID:", docRef.id);
                
                alert("‚úÖ Feedback submitted successfully!");
                feedbackForm.reset();
                
            .catch((error) => {
                console.error("Feedback submission error:", error);
                alert("‚ö†Ô∏è Error submitting feedback: " + error.message);
            });
        };

        // Wait for Firebase to initialize before setting up event handlers
        document.addEventListener('firebaseInitialized', setupAuthHandlers);

        function setupAuthHandlers() {
            const { auth, db } = getFirebase();
            
            // Store Firebase services in global variables for the handlers
            globalAuth = auth;
            globalDb = db;
            
            if (!auth || !db) {
                console.error("Firebase auth or db not initialized");
                return;
            }

            // Logout Handler
            logoutButton.addEventListener("click", async () => {
                try {
                    await signOut(auth);
                    
                    // Show auth section, hide dashboard
                    authSection.style.display = "block";
                    dashboard.style.display = "none";
                    
                    // Clear feedback messages
                    feedbackMessages.innerHTML = "";
                    
                    alert("‚úÖ Logged out successfully!");
                } catch (error) {
                    console.error("Logout error:", error);
                    alert("‚ö†Ô∏è " + error.message);
                }
            });

            // Auth State Change Listener
            onAuthStateChanged(auth, (user) => {
                if (user) {
                    // User is signed in
                    userEmailSpan.textContent = user.email;
                    authSection.style.display = "none";
                    dashboard.style.display = "block";
                    loadUserFeedback(user.uid);
                } else {
                    // User is signed out
                    authSection.style.display = "block";
                    dashboard.style.display = "none";
                }
            });
        }

        // Load User Feedback from Firestore with Debug Logging
        function loadUserFeedback(userId) {
            console.log("Loading feedback for user:", userId);
            
            if (!globalDb) {
                console.error("Firestore not initialized");
                feedbackMessages.innerHTML = "<p>Error: Database connection not available</p>";
                return;
            }
            
            try {
                // Try to get a reference to the feedback collection
                const feedbackCollection = collection(globalDb, "feedback");
                
                // Log to verify collection access
                console.log("Accessing feedback collection");
                
                // Create query for user's feedback - notice we're removing orderBy for now
                // This is because it can cause errors if you don't have the right indexes set up
                const q = query(
                    feedbackCollection, 
                    where("userId", "==", userId)
                );
                
                console.log("Query created, setting up real-time listener");
                
                // Listen for real-time updates
                onSnapshot(q, (snapshot) => {
                    console.log("Feedback snapshot received, documents count:", snapshot.size);
                    feedbackMessages.innerHTML = "";
                    
                    if (snapshot.empty) {
                        console.log("No feedback found for this user");
                        feedbackMessages.innerHTML = "<p>No feedback submitted yet. Try adding some!</p>";
                    } else {
                        snapshot.forEach((doc) => {
                            const data = doc.data();
                            console.log("Feedback document:", doc.id, data);
                            
                            // Check for either feedback or message field
                            const feedbackContent = data.feedback || data.message || "No content";
                            
                            // Handle different timestamp formats
                            let dateDisplay = "Unknown date";
                            if (data.timestamp) {
                                try {
                                    // Try to handle Firestore timestamp objects
                                    if (typeof data.timestamp.toDate === 'function') {
                                        dateDisplay = data.timestamp.toDate().toLocaleString();
                                    } else {
                                        // Handle regular Date objects or timestamps
                                        dateDisplay = new Date(data.timestamp).toLocaleString();
                                    }
                                } catch (err) {
                                    console.error("Error formatting date:", err);
                                }
                            }
                            
                            // Sanitize feedback using DOMPurify
                            const sanitizedFeedback = DOMPurify.sanitize(feedbackContent);
                            
                            // Add the feedback item to the display
                            feedbackMessages.innerHTML += `
                                <div class="feedback-item">
                                    <p class="feedback-text">${sanitizedFeedback}</p>
                                    <p class="feedback-date">${dateDisplay}</p>
                                </div>
                            `;
                        });
                    }
                }, error => {
                    console.error("Error loading feedback:", error);
                    feedbackMessages.innerHTML = `<p class="error">Error loading feedback: ${error.message}</p>`;
                });
            } catch (error) {
                console.error("Error setting up feedback listener:", error);
                feedbackMessages.innerHTML = `<p class="error">Error setting up feedback listener: ${error.message}</p>`;
            }
        }

        // Try to initialize immediately as well (in case the event already fired)
        setupAuthHandlers();
    </script>

    <section class="intro">
        <h2>üåê Welcome Hackers & Builders!</h2>
        <p>üöÄ <strong>Hello Everyone!</strong> Welcome to the official landing page for <strong>Group Meshtacular</strong>!</p>
        <h3>üë• Our Team</h3>
        <ul>
            <li>üî• <strong>Sean Griffiths</strong></li>
            <li>üè¥‚Äç‚ò†Ô∏è <strong>Luca Maddaleni</strong></li>
            <li>üõ∏ <strong>Robert Stanley</strong></li>
        </ul>
    </section>

    <section class="about">
        <h2>üìå What is Meshtacular?</h2>
        <p>Meshtacular is a <strong>group of Undergrads at Georgia State University</strong> focused on developing <strong>secure, efficient, and innovative</strong> software. This website serves as:</p>
        <ul>
            <li>üìÇ A <strong>landing page</strong> for our group‚Äôs progress.</li>
            <li>üì° A hub for <strong>our networking-based projects</strong>.</li>
            <li>üõ† A place to <strong>document our coding journey</strong> and discoveries.</li>
        </ul>
    </section>

    <section class="roadmap">
        <h2>üèóÔ∏è Project 1 Roadmap</h2>
        <table>
            <tr>
                <th>Phase</th>
                <th>Task</th>
                <th>Status</th>
            </tr>
            <tr>
                <td>üü¢</td>
                <td><strong>Setup GitHub Pages</strong></td>
                <td>‚úÖ Completed</td>
            </tr>
            <tr>
                <td>üü°</td>
                <td><strong>Implement Website Design</strong></td>
                <td>‚úÖ Completed</td>
            </tr>
            <tr>
                <td>üî¥</td>
                <td><strong>Develop Core Networking Features</strong></td>
                <td>‚úÖ Completed</td>
            </tr>
            <tr>
                <td>üü£</td>
                <td><strong>Optimize & Deploy</strong></td>
                <td>‚úÖ Completed</td>
            </tr>
        </table>
    </section>

    <section class="project-list">
        <h2>üöÄ Featured Projects</h2>
        <p>Check out our latest developments in networking and security.</p>
        <ul>
            <li><strong>Project 1:</strong> This Project Portfolio Website!</li>
            <li><strong>Project 2:</strong> Secure Communication with a Decentralized Mesh Messaging App **Coming Soon**</li>
            <li><strong>Project 3:</strong> TBA!</li>
        </ul>
    </section>

    <section class="security-notice">
        <h2>üîí Security & Networking Details</h2>
        <p>This website follows security best practices, including:</p>
        <ul>
            <li>‚úÖ <strong>DNS:</strong> Resolves the domain <code>group-meshtacular.web.app/</code> to an IP address.</li>
            <li>‚úÖ <strong>IP Address:</strong> Hosted on Firebase‚Äôs infrastructure (<code>199.36.158.100</code>).</li>
            <li>‚úÖ <strong>HTTPS:</strong> Secure encryption enabled using SSL.</li>
            <li>‚úÖ <strong>HTTP Protocol:</strong> Requests are served using HTTP/HTTPS.</li>
        </ul>
        <p>Check the üîí padlock in the address bar for a secure connection!</p>
    </section>

    <section class="technologies">
        <h2>üõ† Technologies Used</h2>
        <ul>
            <li>üåç <strong>HTML & CSS</strong> ‚Äì Structuring and styling the website.</li>
            <li>üé® <strong>Custom Dark UI</strong> ‚Äì A hacker-style aesthetic.</li>
            <li>üîß <strong>GitHub Pages</strong> ‚Äì Free hosting.</li>
            <li>üîê <strong>Cybersecurity Best Practices</strong> ‚Äì HTTPS, DNS, IP handling.</li>
        </ul>
    </section>

    <footer>
        <h2>üöÄ Stay Tuned!</h2>
        <p>üõ°Ô∏è As we develop this website, we‚Äôll continue to add <strong>new features, security enhancements, and networking tools</strong>. Stay tuned and follow our progress!</p>
        <p>üíª <em>Happy Hacking!</em> üï∂Ô∏è</p>
         <pre style="font-family: 'Fira Code', monospace; text-align: center; color: #6899ca; background-color: #161b22; padding: 20px; border-radius: 10px; margin-top: 20px; font-size: 5px;">
            .,,uod8B8bou,,.
            ..,uod8BBBBBBBBBBBBBBBBRPFT?l!i:.
       ,=m8BBBBBBBBBBBBBBBRPFT?!||||||||||||||
       !...:!TVBBBRPFT||||||||||!!^^""'   ||||
       !.......:!?|||||!!^^""'            ||||
       !.........||||                     ||||
       !.........||||  ##                 ||||
       !.........||||                     ||||
       !.........||||                     ||||
       !.........||||                     ||||
       !.........||||                     ||||
       `.........||||                    ,||||
        .;.......||||               _.-!!|||||
 .,uodWBBBBb.....||||       _.-!!|||||||||!:'
!YBBBBBBBBBBBBBBb..!|||:..-!!|||||||!iof68BBBBBb....
!..YBBBBBBBBBBBBBBb!!||||||||!iof68BBBBBBRPFT?!::   `.
!....YBBBBBBBBBBBBBBbaaitf68BBBBBBRPFT?!:::::::::     `.
!......YBBBBBBBBBBBBBBBBBBBRPFT?!::::::;:!^"`;:::       `.
!........YBBBBBBBBBBRPFT?!::::::::::^''...::::::;         iBBbo.
`..........YBRPFT?!::::::::::::::::::::::::;iof68bo.      WBBBBbo.
`..........:::::::::::::::::::::::;iof688888888888b.     `YBBBP^'
  `........::::::::::::::::;iof688888888888888888888b.     `
    `......:::::::::;iof688888888888888888888888888888b.
      `....:::;iof688888888888888888888888888888888899fT!
        `..::!8888888888888888888888888888888899fT|!^"'
          `' !!988888888888888888888888899fT|!^"'
              `!!8888888888888888899fT|!^"'
                `!988888888899fT|!^"'
                  `!9899fT|!^"'
                    `!^"'
         </pre>
    </footer>

</body>
</html>



